<?php
/**
 * @file
 * Code for the Walkthrough global feature.
 */

include_once 'walkthrough_global.features.inc';


/**
 * Implements hook_menu().
 */
function walkthrough_global_menu() {
  $items = array();

  $items['admin/config/services/walkthrough'] = array(
    'title' => 'Walkthrough configuration',
    'type' => MENU_NORMAL_ITEM,
    'access arguments' => array('administer walkthrough'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('walkthrough_global_configuration_form'),
    'file' => 'walkthrough_global.admin.inc'
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function walkthrough_global_permission() {
  return array(
    'administer walkthrough' => array(
      'title' => t('Administer walkthrough'),
    ),
  );
}

/**
 * Implements hook_libraries_info().
 */
function walkthrough_global_libraries_info() {
  $libraries['phpseclib'] = array(
    'name' => 'phpseclib',
    'vendor url' => 'http://phpseclib.sourceforge.net',
    'download url' => 'http://phpseclib.sourceforge.net',
    'version' => '0.3.5',
    'files' => array(
      'php' => array(
        'Crypt/RSA.php',
      ),
    ),
  );
  return $libraries;
}

/**
 * Implements hook_services_resources().
 */
function walkthrough_global_services_resources() {
  $resources = array();

  $resources['walkhub-user'] = array(
    'actions' => array(
      'registration' => array(
        'help' => 'Create a new user account.',
        'callback' => '_walkthrough_global_resource_registration',
        'args' => array(
          array(
            'name' => 'username',
            'type' => 'string',
            'description' => 'A valid username',
            'source' => array(
              'data' => 'username',
            ),
            'optional' => FALSE,
          ),
          array(
            'name' => 'mail',
            'type' => 'string',
            'description' => 'A valid e-mail',
            'source' => array(
              'data' => 'mail',
            ),
            'optional' => FALSE,
          ),
          array(
            'name' => 'password',
            'type' => 'string',
            'description' => 'A valid password',
            'source' => array(
              'data' => 'password',
            ),
            'optional' => FALSE,
          ),
          array(
            'name' => 'rsatoken',
            'type' => 'string',
            'description' => 'A valid token to filter out robots.',
            'source' => array(
              'data' => 'token',
            ),
            'optional' => FALSE,
          ),
        ),
        'access callback' => '_walkthrough_global_resource_registration_access',
        'access arguments append' => TRUE,
        'file' => array(
          'type' => 'inc',
          'module' => 'walkthrough_global',
          'name' => 'walkthrough_global.services',
        ),
      ),
    ),
  );

  return $resources;
}

/**
 * Access callback to prevent the robots creating new account using this endpoint.
 */
function _walkthrough_global_resource_registration_access() {
  $public_key = variable_get('walkthrough_global_public_key', NULL);
  // Check that every necessary variable exists.
  if (!is_null($public_key) && !empty($_POST['username']) && !empty($_POST['password']) && !empty($_POST['mail']) && !empty($_POST['token'])) {
    // Try to load the phpseclib library.
    $library = libraries_load("phpseclib");

    // If the library loaded successfully start the validation process.
    if (!empty($library['loaded'])) {
      $rsa = new Crypt_RSA();
      $rsa->loadKey($public_key);
      // Decrypt the received token.
      $decrypted_token = $rsa->decrypt($_POST['token']);
      // The following string should be the result of the decryption process.
      $expected_token_result = $_POST['username'] . $_POST['password'] . $_POST['mail'];

      if ($decrypted_token === $expected_token_result) {
        return TRUE;
      }
    }
  }

  return FALSE;
}
